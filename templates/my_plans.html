{% extends "base.html" %}

{% block title %}My Plans - Study Planner{% endblock %}

{% block content %}
<div class="px-4 sm:px-6 lg:px-8">
    <div class="sm:flex sm:items-center">
        <div class="sm:flex-auto">
            <h1 class="text-2xl font-semibold text-gray-900">My Study Plans</h1>
            <p class="mt-2 text-sm text-gray-700">A list of all your personalized study plans and your current progress.</p>
        </div>
        <div class="mt-4 sm:mt-0 sm:ml-16 sm:flex-none">
            <a href="/study_plan_creator_frontend" class="inline-flex items-center justify-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                Create New Plan
            </a>
        </div>
    </div>

    <div class="mt-8 grid gap-6 grid-cols-1 md:grid-cols-2 lg:grid-cols-3">
        {% for plan in plans %}
        <div id="plan-card-{{ plan.id }}" class="bg-white overflow-hidden shadow rounded-lg flex flex-col">
            <div class="px-4 py-5 sm:p-6 flex-grow">
                <div class="flex justify-between items-start">
                    <h3 class="text-lg leading-6 font-medium text-gray-900">{{ plan.title }}</h3>
                    {% if plan.is_public %}
                    <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800">Public</span>
                    {% else %}
                    <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-gray-100 text-gray-800">Private</span>
                    {% endif %}
                </div>
                <p class="mt-2 text-sm text-gray-500">{{ plan.goal[:100] }}{% if plan.goal|length > 100 %}...{% endif %}</p>
                <div class="mt-4">
                    <div class="flex items-center justify-between text-xs text-gray-500 mb-1">
                        <span>Progress</span>
                        <span id="progress-text-{{ plan.id }}">{{ plan.progress }}% Complete</span>
                    </div>
                    <div class="w-full bg-gray-200 rounded-full h-2">
                        <div class="bg-indigo-600 h-2 rounded-full progress-bar-fill" style="width: {{ plan.progress }}%"></div>
                    </div>
                </div>
            </div>
            <div class="bg-gray-50 px-4 py-4 sm:px-6 flex flex-col space-y-3">
                <div class="flex justify-between items-center">
                    <button onclick="viewPlan({{ plan.id }})" class="text-indigo-600 hover:text-indigo-900 text-sm font-medium">
                        <i class="fas fa-eye mr-1"></i> View Plan
                    </button>
                    <button onclick="deletePlan({{ plan.id }})" class="text-red-600 hover:text-red-900 text-sm font-medium">
                        <i class="fas fa-trash-alt"></i>
                    </button>
                    <span class="text-xs font-semibold text-gray-600" id="progress-text-{{ plan.id }}">{{ plan.progress }}% Complete</span>
                </div>
                <input type="range" min="0" max="100" value="{{ plan.progress }}" 
                       class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer accent-indigo-600"
                       oninput="document.getElementById('progress-text-{{ plan.id }}').innerText = this.value + '% Complete'; document.querySelector('#plan-card-{{ plan.id }} .progress-bar-fill').style.width = this.value + '%';"
                       onchange="updateProgress({{ plan.id }}, this.value)">
            </div>
            
            <!-- Hidden Content for Modal/View -->
            <div id="plan-content-{{ plan.id }}" class="hidden">
                {{ plan.content }}
            </div>
        </div>
        {% endfor %}
    </div>
</div>

<!-- Simple Modal -->
<div id="planModal" class="fixed z-50 inset-0 hidden overflow-y-auto" aria-labelledby="modal-title" role="dialog" aria-modal="true">
    <div class="flex items-end justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
        <div class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity" aria-hidden="true"></div>
        <span class="hidden sm:inline-block sm:align-middle sm:h-screen" aria-hidden="true">&#8203;</span>
        <div class="inline-block align-middle bg-white rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-4xl sm:w-full">
            <div class="bg-white px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
                <div class="flex flex-col md:flex-row justify-between items-start">
                    <div class="w-full md:w-3/4">
                        <h3 class="text-2xl leading-6 font-bold text-gray-900" id="modal-title">Plan Details</h3>
                        <div class="mt-6 prose max-w-none" id="modal-content">
                            <!-- Content here -->
                        </div>
                    </div>
                    <div class="w-full md:w-1/4 mt-8 md:mt-0 md:pl-6 space-y-4">
                        <div class="bg-indigo-50 p-4 rounded-lg">
                            <h4 class="text-xs font-bold text-indigo-700 uppercase mb-3">AI Tools</h4>
                            <button onclick="aiQuiz()" class="w-full mb-2 inline-flex items-center justify-center px-3 py-2 border border-transparent text-xs font-medium rounded-md text-white bg-indigo-600 hover:bg-indigo-700">
                                <i class="fas fa-question-circle mr-2"></i> Generate Quiz
                            </button>
                            <button onclick="aiSuggest()" class="w-full mb-2 inline-flex items-center justify-center px-3 py-2 border border-transparent text-xs font-medium rounded-md text-indigo-700 bg-indigo-100 hover:bg-indigo-200">
                                <i class="fas fa-lightbulb mr-2"></i> Get Help (Stuck?)
                            </button>
                            <button onclick="aiReschedule()" class="w-full inline-flex items-center justify-center px-3 py-2 border border-transparent text-xs font-medium rounded-md text-gray-700 bg-white border-gray-300 hover:bg-gray-50">
                                <i class="fas fa-calendar-alt mr-2"></i> Adaptive Reschedule
                            </button>
                        </div>
                        <div id="ai-tool-loading" class="hidden text-center py-4">
                            <i class="fas fa-spinner fa-spin text-indigo-600"></i>
                            <p class="text-[10px] text-gray-500 mt-1">AI is thinking...</p>
                        </div>
                        <div id="ai-tool-result" class="hidden bg-white border border-gray-200 p-4 rounded-lg text-sm max-h-[400px] overflow-y-auto">
                            <!-- AI Result here -->
                        </div>
                    </div>
                </div>
            </div>
            <div class="bg-gray-50 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse">
                <button type="button" onclick="closeModal()" class="mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 sm:mt-0 sm:ml-3 sm:w-auto sm:text-sm">
                    Close
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    const converter = new showdown.Converter();
    let currentPlanId = null;
    let currentPlanTasks = [];

    async function viewPlan(id) {
        currentPlanId = id;
        const rawContent = document.getElementById(`plan-content-${id}`).innerText;
        
        // Fetch plan details to get completed_tasks
        const response = await fetch(`/plan_details/${id}`);
        const data = await response.json();
        const completedTasks = data.completed_tasks || [];

        // Convert Markdown to HTML
        let htmlContent = converter.makeHtml(rawContent);
        
        // Wrap list items in interactive checkboxes
        const tempDiv = document.createElement('div');
        tempDiv.innerHTML = htmlContent;
        
        const listItems = tempDiv.querySelectorAll('li');
        currentPlanTasks = Array.from(listItems);
        
        listItems.forEach((li, index) => {
            const isChecked = completedTasks.includes(index);
            const checkbox = `<input type="checkbox" class="task-checkbox mr-2 h-4 w-4 text-indigo-600 focus:ring-indigo-500 border-gray-300 rounded" 
                                     ${isChecked ? 'checked' : ''} 
                                     onchange="toggleTask(${index})">`;
            li.style.listStyle = 'none';
            li.innerHTML = `<div class="flex items-start mb-2">${checkbox}<span>${li.innerHTML}</span></div>`;
        });

        document.getElementById('modal-content').innerHTML = tempDiv.innerHTML;
        document.getElementById('ai-tool-result').classList.add('hidden');
        document.getElementById('planModal').classList.remove('hidden');
    }

    async function toggleTask(index) {
        const total = currentPlanTasks.length;
        try {
            const response = await fetch(`/toggle_task/${currentPlanId}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ task_idx: index, total_tasks: total })
            });
            const data = await response.json();
            if (data.success) {
                // Update local UI
                document.getElementById(`progress-text-${currentPlanId}`).innerText = data.progress + '% Complete';
                // Update the progress bar on the card
                const cardProgressBar = document.querySelector(`#plan-card-${currentPlanId} .progress-bar-fill`);
                if (cardProgressBar) {
                    cardProgressBar.style.width = data.progress + '%';
                }
            }
        } catch (error) {
            console.error('Error toggling task:', error);
        }
    }

    async function aiQuiz() {
        showAiLoading(true);
        const response = await fetch(`/generate_quiz/${currentPlanId}`, { method: 'POST' });
        const data = await response.json();
        showAiLoading(false);
        if (data.quiz) {
            showAiResult(data.quiz);
        }
    }

    async function aiSuggest() {
        const roadblock = prompt("What are you stuck on?");
        if (!roadblock) return;
        
        showAiLoading(true);
        const response = await fetch(`/suggest_resources/${currentPlanId}`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ roadblock })
        });
        const data = await response.json();
        showAiLoading(false);
        if (data.suggestions) {
            showAiResult(data.suggestions);
        }
    }

    async function aiReschedule() {
        if (!confirm("This will use AI to re-balance your remaining tasks. Continue?")) return;
        
        showAiLoading(true);
        const response = await fetch(`/reschedule_plan/${currentPlanId}`, { method: 'POST' });
        const data = await response.json();
        showAiLoading(false);
        if (data.new_content) {
            document.getElementById('modal-content').innerHTML = converter.makeHtml(data.new_content);
            document.getElementById(`plan-content-${currentPlanId}`).innerHTML = data.new_content;
            alert("Plan rescheduled!");
        }
    }

    function showAiLoading(show) {
        document.getElementById('ai-tool-loading').classList.toggle('hidden', !show);
        document.getElementById('ai-tool-result').classList.add('hidden');
    }

    function showAiResult(content) {
        const resultDiv = document.getElementById('ai-tool-result');
        resultDiv.innerHTML = `<div class="prose prose-sm">${converter.makeHtml(content)}</div>`;
        resultDiv.classList.remove('hidden');
    }

    function closeModal() {
        document.getElementById('planModal').classList.add('hidden');
    }

    async function updateProgress(id, val) {
        try {
            const response = await fetch(`/update_progress/${id}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ progress: parseInt(val) })
            });
            if (response.ok) {
                // Optional: update progress bar without reload
                document.querySelector(`div[style="width: ${document.getElementById('progress-text-'+id).innerText.split('%')[0]}%"]`).style.width = val + '%';
            }
        } catch (error) {
            console.error('Error updating progress:', error);
        }
    }

    async function deletePlan(id) {
        if (confirm('Are you sure you want to delete this plan?')) {
            try {
                const response = await fetch(`/delete_plan/${id}`, {
                    method: 'POST'
                });
                if (response.ok) {
                    location.reload();
                }
            } catch (error) {
                console.error('Error deleting plan:', error);
            }
        }
    }
</script>
{% endblock %}
